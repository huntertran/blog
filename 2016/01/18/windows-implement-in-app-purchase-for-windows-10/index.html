<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=""><meta name="theme-color" content="#2d4356"><meta name="baidu-site-verification"><title>[Windows] Implement In-App Purchase for Windows 10 | Tuan Tran's Blog</title><link rel="stylesheet" type="text/css" href="/blog/css/style.css"><link rel="Shortcut Icon" type="image/x-icon" href="/blog/favicon.png"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"></script><meta name="generator" content="Hexo 5.0.0"><link rel="alternate" href="/blog/atom.xml" title="Tuan Tran's Blog" type="application/atom+xml">
</head><link rel="stylesheet" type="text/css" href="/blog/plugins/prettify/doxy.css"><script type="text/javascript" src="/blog/js/ready.js" async></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css"><body class="night"><div class="mobile-head" id="mobile-head"><div class="navbar-icon"><span></span><span></span><span></span></div><div class="navbar-title"><a href="/">LITREILY</a></div><div class="navbar-search"><!--= show a circle here--></div></div><div class="h-wrapper" id="menu"><nav class="h-head box"><div class="m-hdimg"><a class="hdimg img" href="/"><img class="nofancybox" src="/img/profile.jpg" width="128" height="128"></a><h1 class="ttl"><a href="/">Tuan Tran's Blog</a></h1></div><p class="m-desc">Share to be shared</p><div class="m-nav"><ul><li><span class="dot">●</span><a href="/blog/archives/">Archives</a></li><li><span class="dot">●</span><a href="/blog/categories/">Categories</a></li><li><span class="dot">●</span><a href="/blog/tags/">Tags</a></li><li><span class="dot">●</span><a href="/blog/about/">About</a></li><li><span class="dot">●</span><a href="/blog/atom.xml">RSS</a></li><li class="m-sch"><form class="form" id="j-formsch" method="get"><input class="txt" type="text" id="local-search-input" name="q" value="Search for" onfocus="if(this.value=='Search for'){this.value='';}" onblur="if(this.value==''){this.value='Search for';}"><input type="text" style="display:none;"></form></li></ul><div id="local-search-result"></div></div></nav></div><div id="back2Top"><a class="fa fa-arrow-up" title="Back to top" href="#"></a></div><div class="box" id="container"><div class="l-wrapper"><div class="l-content box"><div class="l-post l-post-art"><article class="p-art"><div class="p-header box"><h1 class="p-title">[Windows] Implement In-App Purchase for Windows 10</h1><div class="p-info"><span class="p-date"><i class="fa fa-calendar"></i><a href="/blog/2016/01/18/windows-implement-in-app-purchase-for-windows-10/">2016-01-18</a></span><span class="p-category"><i class="fa fa-folder"></i><a href="/blog/categories/C/">C#</a>&nbsp;&bull;&nbsp;<a href="/blog/categories/c/">c</a>&nbsp;&bull;&nbsp;<a href="/blog/categories/c/Windows-10/">Windows 10</a>&nbsp;&bull;&nbsp;<a href="/blog/categories/c/Windows-10/Windows-Store-App/">Windows Store App</a></span><span class="p-view" id="busuanzi_container_page_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_page_pv"></span></span></div></div><div class="p-content"><p>Bạn có một app thặc là tuyệt zời ông mặt trời, tính năng độc đáo, hấp dẫn. Người dùng không thể nào rời mắt khỏi app của bạn. Và bạn quyết định kiếm tiền từ nó. Thế là bạn tìm hiểu cách implement tính năng In-App Purchase của Windows 10 và nhận ra…nó quá phức tạp. Cùng nhau bơi zô nhé.</p>
<a id="more"></a>
<ul>
<li><a href="#official-documents">Official Documents</a></li>
<li><a href="#keywords">Keywords</a></li>
<li><a href="#the-un-official-yet-worked-ways">The Un-official (yet worked) ways</a><ul>
<li><a href="#step-1-publish-your-app-to-the-store">Step 1: Publish your app to the Store</a></li>
<li><a href="#step-2-create-iap-aka-in-app-purchase">Step 2: Create IAP (aka In-App Purchase)</a></li>
<li><a href="#step-3-the-tricky">Step 3: The tricky</a><ul>
<li><a href="#s%E1%BB%AD-d%E1%BB%A5ng-currentappsimulator">Sử dụng CurrentAppSimulator</a></li>
<li><a href="#hi%E1%BB%87n-gi%C3%A1-v%C3%A0-c%C3%A1c-th%C3%B4ng-tin-kh%C3%A1c-c%E1%BB%A7a-s%E1%BA%A3n-ph%E1%BA%A9m">Hiện giá (và các thông tin khác) của sản phẩm</a></li>
<li><a href="#mua-in-app-purchase">Mua In-App Purchase</a></li>
</ul>
</li>
<li><a href="#step-4-change-the-test-code-to-actual-code">Step 4: Change the test code to actual code</a></li>
</ul>
</li>
</ul>
<h1 id="Official-Documents"><a href="#Official-Documents" class="headerlink" title="Official Documents"></a>Official Documents</h1><p>Microsoft có tài liệu cho vụ này, thậm chí có cả sample code, nhưng nó sẽ không giúp ích được gì cho bạn. Tất cả đều khá chung chung, khơi khơi, mù mờ</p>
<ul>
<li>Enable In-App Purchase: <a target="_blank" rel="noopener" href="https://msdn.microsoft.com/en-us/library/windows/apps/mt219684.aspx">https://msdn.microsoft.com/en-us/library/windows/apps/mt219684.aspx</a></li>
<li>Enable consumable in-app product purchases: <a target="_blank" rel="noopener" href="https://msdn.microsoft.com/en-us/library/windows/apps/mt219683.aspx">https://msdn.microsoft.com/en-us/library/windows/apps/mt219683.aspx</a></li>
<li>Manage a large catalog of in-app products (Not really): <a target="_blank" rel="noopener" href="https://msdn.microsoft.com/en-us/library/windows/apps/mt219686.aspx">https://msdn.microsoft.com/en-us/library/windows/apps/mt219686.aspx</a></li>
</ul>
<p>Đọc từng câu từng chữ trong 3 cái tài liệu trên, tất cả những gì bạn có thể viết trong code là ít vô cùng. Hy vọng rằng trong tương lai điều này sẽ thay đổi. Giờ hãy thử theo cách khác nhóe</p>
<h1 id="Keywords"><a href="#Keywords" class="headerlink" title="Keywords"></a>Keywords</h1><p>Phần này chứa các keywords mà bạn hay nhầm lẫn khi implement tính năng này</p>
<ul>
<li><p>Consumables: User có thể mua loại này bao nhiu tùy thích (tiu bỉu cho thể loại này là tiền trong game, quyền truy cập vào kho sách – nhạc – blah blah blah trong 6 tháng) <img src="https://farm2.staticflickr.com/1479/24372150901_025d567d60_o.png"></p>
</li>
<li><p>Durables: User mua thể loại này một lần rồi là sẽ sở hữu nó mãi mãi. Ví dụ như level mới, màn chơi mới, vật phẩm</p>
</li>
<li><p>ProductID: chính là ID của product của bạn. Đây sẽ là thông số đầu tiên khi tạo một In-App Purchase mới trên Dev Center</p>
</li>
</ul>
<h1 id="The-Un-official-yet-worked-ways"><a href="#The-Un-official-yet-worked-ways" class="headerlink" title="The Un-official (yet worked) ways"></a>The Un-official (yet worked) ways</h1><h2 id="Step-1-Publish-your-app-to-the-Store"><a href="#Step-1-Publish-your-app-to-the-Store" class="headerlink" title="Step 1: Publish your app to the Store"></a>Step 1: Publish your app to the Store</h2><p>Việc đầu tiên bạn muốn làm sẽ là publish app của bạn lên Store. “Nhưng app vẫn đang trong giai đoạn dev, chưa publish được” – “App chưa có gì cả” – “App vẫn chưa hoàn thiện hết các tính năng” Không sao cả. Store cho phép bạn publish app của bạn, và ẩn khỏi ô tìm kiếm. Chỉ những ai có deep link (link dẫn trực tiếp tới app của bạn) mới có thể tải về và sử dụng. Như vậy bạn đã có thể ngăn chặn người dùng tìm ra app của bạn và tải nó về, tận hưởng những thứ đáng lẽ ra phải mua bằng Obama. \[caption id=”” align=”aligncenter” width=”1108”\]<img src="https://farm2.staticflickr.com/1563/24454812865_46046851ea_o.png"> Hide this app in the Store[/caption]</p>
<h2 id="Step-2-Create-IAP-aka-In-App-Purchase"><a href="#Step-2-Create-IAP-aka-In-App-Purchase" class="headerlink" title="Step 2: Create IAP (aka In-App Purchase)"></a>Step 2: Create IAP (aka In-App Purchase)</h2><p>In-App Purchase hoàn toàn riêng biệt với app của bạn. Và cũng sẽ được xét duyệt như 1 app, nhưng thường chỉ mất khoảng 1 tiếng đồng hồ cho quá trình đó (quá chậm) Các bước tạo In-App Purchase, cũng như publish app, thì mỗi thời mỗi khác. Tóm lại là cứ làm theo hướng dẫn trên màn hình là được \[caption id=”” align=”aligncenter” width=”653”\]<img src="https://farm2.staticflickr.com/1538/24087084229_5b67cc60ea_o.png"> Tạo một In-App Purchase[/caption]</p>
<h2 id="Step-3-The-tricky"><a href="#Step-3-The-tricky" class="headerlink" title="Step 3: The tricky"></a>Step 3: The tricky</h2><p>In-App Purchase sẽ ko chạy khi bạn có 1 trong các điều kiện sau</p>
<ul>
<li>In-App Purchase vừa mới tạo xong, chưa kịp lên đã lật đật đòi test</li>
<li>Chưa có sản phẩm trên In-App Purchase trong Dev Center</li>
</ul>
<p>Bạn sẽ nghĩ: quá đơn giản, chỉ cần tạo sản phẩm trên In-App Purchase, chờ 1 tiếng đồng hồ để nó lên, sau đó vào lại app, chuyển sang chế độ Release là xong. Tuy nhiên</p>
<ul>
<li>Đặt Break-point ở các dòng code liên quan tới In-App Purchase sẽ không xem được data</li>
<li>Dù đã có sản phẩm, nhưng vẫn ko liệt kê ra khi hiển thị lên màn hình (count == 0)</li>
</ul>
<p>Và đây sẽ là cách. Lưu ý làm theo đúng thứ tự được trình bày trong blog này</p>
<h3 id="Su-dung-CurrentAppSimulator"><a href="#Su-dung-CurrentAppSimulator" class="headerlink" title="Sử dụng CurrentAppSimulator"></a>Sử dụng CurrentAppSimulator</h3><p>Trong method khởi tạo hoặc load data cho app của bạn, đặt các dòng code sau [code lang=csharp] StaticData.license = CurrentAppSimulator.LicenseInformation; StaticData.listings = await CurrentAppSimulator.LoadListingInformationAsync(); [/code] StaticData là một class chứa các biến Static, có thể truy cập ở mọi class khác Ngay sau khi chạy đoạn code này, Visual Studio sẽ tạo ra 1 file XML giả ở C:\Users\\AppData\Local\Packages\\LocalState\Microsoft\Windows Store\ApiData\WindowsStoreProxy.xml Bạn mở nó lên, và sửa các giá trị sau [code lang=xml] <App> <IsActive>true</IsActive> <IsTrial>false</IsTrial> </App> [/code] Mục Product ID, sửa lại cho trùng với Product ID bạn đã đặt trên Dev Center</p>
<h3 id="Hien-gia-va-cac-thong-tin-khac-cua-san-pham"><a href="#Hien-gia-va-cac-thong-tin-khac-cua-san-pham" class="headerlink" title="Hiện giá (và các thông tin khác) của sản phẩm"></a>Hiện giá (và các thông tin khác) của sản phẩm</h3><p>Như bạn đã thấy rõ, StaticData.listings chứa toàn bộ In-App Purchase của bạn. Mọi sản phẩm đều có mặt trong này. Như vậy, để gắn giá lên một sản phẩm nào đó, ngoài việc có template, model ra, bạn sẽ cần phải chạy một vòng lặp [code lang=csharp] foreach (KeyValuePair&lt;string, ProductListing&gt; productListing in StaticData.listings.ProductListings) { if (productListing.Key.TrimStart(‘0’) == issue.id) { issue.billing.price = productListing.Value.FormattedPrice; } } [/code] Trong đoạn code trên, Product ID của mình là 0154, và issue.id là “154” FormattedPrice sẽ bao gồm cả đơn vị tiền tệ mà hệ thống đang sử dụng. Bạn cũng có thể đọc các thông tin khác như Description, Tag, vân vân và vân vân</p>
<h3 id="Mua-In-App-Purchase"><a href="#Mua-In-App-Purchase" class="headerlink" title="Mua In-App Purchase"></a>Mua In-App Purchase</h3><p>Nhờ sự giúp đỡ của CurrentAppSimulator, bạn có thể test mua thoải mái. Chỉ cần chỉnh sửa các giá trị trong file WindowsStoreProxy.xml để test đi test lại Về cơ bản, đoạn code mua một vật phẩm bằng In-App Purchase sẽ như sau [code lang=csharp] if (!StaticData.license.ProductLicenses[_selectedIssue.billing.iapKey].IsActive) { try { // Người dùng chưa từng mua cái này // Hiện hộp thoại mua await CurrentAppSimulator.RequestProductPurchaseAsync(_selectedIssue.billing.iapKey); //Kiểm tra lại xem đã mua thành công chưa if (StaticData.license.ProductLicenses[_selectedIssue.billing.iapKey].IsActive) { //Nếu mua thành công thì làm trò mèo gì đó } } catch (Exception) { // Mua bị lỗi // an error occurred. } } else { // Đã mua cái này rồi, tiếp tục trò mèo } [/code] Và khi test thử, lúc gọi đoạn code này, một hộp thoại nhỏ hiện ra, cho phép bạn giả lập các trường hợp có thể xảy ra khi dùng thật <img src="https://farm2.staticflickr.com/1616/23825747414_ddb694db19_o.png"> Có vẻ tốt rồi. Tới bước cuối cùng nhé</p>
<h2 id="Step-4-Change-the-test-code-to-actual-code"><a href="#Step-4-Change-the-test-code-to-actual-code" class="headerlink" title="Step 4: Change the test code to actual code"></a>Step 4: Change the test code to actual code</h2><p>Step này khá đơn giản, chỉ cẩn thay tất cả những chỗ dùng CurrentAppSimulator thành CurrentApp là được. Và chạy lại app một lần nữa, lần này, khi bấm mua, sẽ có một hộp thoại thật hiện ra đòi bạn nhập mã PIN để tiến hành mua app. Tới bước này coi như là thành công <img src="https://farm2.staticflickr.com/1461/23829331723_6f852496b8_o.png"></p>
<blockquote>
<p>Tips: Bạn nên submit In-App Purchase trên Dev Center trước 1-2 ngày để đảm bảo code thực sẽ chạy tốt (mình đã từng submit xong chờ 1 tiếng để nó lên, rồi chạy code thực thì lại báo là không có in-app purchase nào trên dev center =.=)</p>
</blockquote>
</div><div class="p-copyright"><blockquote><div class="p-copyright-author"><span class="p-copyright-key">Author：</span><span class="p-copytight-value"><a href="mailto:litreily@163.com">Tuan Tran</a></span></div><div class="p-copyright-link"><span class="p-copyright-key">Link to this article：</span><span class="p-copytight-value"><a href="/blog/2016/01/18/windows-implement-in-app-purchase-for-windows-10/">https://huntertran.github.io/blog/2016/01/18/windows-implement-in-app-purchase-for-windows-10/</a></span></div><div class="p-copyright-note"><span class="p-copyright-key">Copyright：</span><span class="p-copytight-value">All rights reserved with<a rel="nofollow" target="_blank" href="https://creativecommons.org/licenses/by-nc/4.0/"> CC BY-NC 4.0 </a>agreement. Include the source <a href="https://huntertran.github.io/blog">Tuan Tran's blog</a>！</span></div></blockquote></div></article><div class="p-info box"><span class="p-tags"><i class="fa fa-tags"></i><a href="/blog/tags/windows-10/">windows 10</a><a href="/blog/tags/iap/">iap</a><a href="/blog/tags/in-app-purchase/">in-app purchase</a><a href="/blog/tags/monetization/">monetization</a></span></div><aside id="toc"><div class="toc-title">Table of Contents</div><nav><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Official-Documents"><span class="toc-number">1.</span> <span class="toc-text">Official Documents</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Keywords"><span class="toc-number">2.</span> <span class="toc-text">Keywords</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#The-Un-official-yet-worked-ways"><span class="toc-number">3.</span> <span class="toc-text">The Un-official (yet worked) ways</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-1-Publish-your-app-to-the-Store"><span class="toc-number">3.1.</span> <span class="toc-text">Step 1: Publish your app to the Store</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-2-Create-IAP-aka-In-App-Purchase"><span class="toc-number">3.2.</span> <span class="toc-text">Step 2: Create IAP (aka In-App Purchase)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-3-The-tricky"><span class="toc-number">3.3.</span> <span class="toc-text">Step 3: The tricky</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Su-dung-CurrentAppSimulator"><span class="toc-number">3.3.1.</span> <span class="toc-text">Sử dụng CurrentAppSimulator</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Hien-gia-va-cac-thong-tin-khac-cua-san-pham"><span class="toc-number">3.3.2.</span> <span class="toc-text">Hiện giá (và các thông tin khác) của sản phẩm</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Mua-In-App-Purchase"><span class="toc-number">3.3.3.</span> <span class="toc-text">Mua In-App Purchase</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-4-Change-the-test-code-to-actual-code"><span class="toc-number">3.4.</span> <span class="toc-text">Step 4: Change the test code to actual code</span></a></li></ol></li></ol></nav></aside></div><section class="p-ext"><div class="l-pager l-pager-dtl box"><a class="prev" href="/blog/2016/02/23/windows-10-prevent-your-app-from-being-hidden-on-windows-store/">&lt; [Windows 10] Prevent your app from being hidden on Windows Store</a><a class="next" href="/blog/2016/01/17/visual-studio-online-tfs-love-slack-and-vice-versa/">[Visual Studio Online] TFS love Slack, and vice versa &gt;</a></div><div id="valine-comment"><style type="text/css">.night .v[data-class=v] a { color: #0F9FB4 !important; }
.night .v[data-class=v] a:hover { color: #216C73 !important; }
.night .v[data-class=v] li { list-style: inherit; }
.night .v[data-class=v] .vwrap { border: 1px solid #223441; border-radius: 0; }
.night .v[data-class=v] .vwrap:hover { box-shadow: 0 0 6px 1px #223441; }
.night .v[data-class=v] .vbtn { border-radius: 0; background: none; }
.night .v[data-class=v] .vlist .vcard .vh { border-bottom-color: #293D4E; }
.night .v[data-class=v] .vwrap .vheader .vinput { border-bottom-color: #223441; }
.night .v[data-class=v] .vwrap .vheader .vinput:focus { border-bottom-color: #339EB4; }
.night .v[data-class=v] code, .night .v[data-class=v] pre,.night .v[data-class=v] .vlist .vcard .vhead .vsys { background: #203240 !important; }
.night .v[data-class=v] code, .night .v[data-class=v] pre { color: #F0F0F0; font-size: 95%; }
.v[data-class=v] .vcards .vcard .vh {border-bottom-color: #223441; }
.night .v[data-class=v] .vcards .vcard .vcontent.expand:before {background: linear-gradient(180deg,rgba(38,57,73,.4),rgba(38,57,73,.9));}
.night .v[data-class=v] .vcards .vcard .vcontent.expand:after {background: rgba(38,57,73,.9)}
</style><div id="vcomment"></div><script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script><script>var notify = 'false' == true ? true : false;
var verify = 'false' == true ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'',
  appKey:'',
  lang: 'en',
  placeholder:'ヾﾉ≧∀≦)o Come on, say something...',
  avatar:'identicon',
  guest_info:guest_info,
  pageSize:'10'
})</script></div></section><footer><p>Copyright © 2016 - 2020 <a href="/blog/." rel="nofollow">Tuan Tran's Blog</a> | <strong><a rel="nofollow" target="_blank" href="https://creativecommons.org/licenses/by-nc/4.0/">CC BY-NC 4.0</a></strong><br><span id="busuanzi_container_site_uv"><i class="fa fa-user"></i><span id="busuanzi_value_site_uv"></span></span> <span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_site_pv"></span></span> | Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a>Theme with<a rel="nofollow" target="_blank" href="https://github.com/litreily/snark-hexo"> snark.</a></p></footer></div></div></div><script type="text/javascript" src="/blog/plugins/prettify/prettify.js"></script><script type="text/javascript" src="/blog/js/search.js"></script><script type="text/javascript" src="/blog/js/top.js"></script><script type="text/javascript" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
    search_path = 'search.xml';
}
var path = '/blog/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script><script type="text/javascript" src="/blog/js/fancybox.js?v=0.0.1" async></script></body></html>